/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  * @author	    : vaish
  ******************************************************************************
  * @attention
  *
  * <h2><center>&copy; Copyright (c) 2021 STMicroelectronics.
  * All rights reserved.</center></h2>
  *
  * This software component is licensed by ST under Ultimate Liberty license
  * SLA0044, the "License"; You may not use this file except in compliance with
  * the License. You may obtain a copy of the License at:
  *                             www.st.com/SLA0044
  *
  ******************************************************************************
  */
#define ARM_MATH_CM4
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "arm_math.h"
#include "math_helper.h"
#include <stdint.h>
#include <math.h>
#include <stdio.h>
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
#define NUM_SAMPLES 750
/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
UART_HandleTypeDef huart2;

/* USER CODE BEGIN PV */

/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_USART2_UART_Init(void);
/* USER CODE BEGIN PFP */
#ifdef __GNUC__
	#define PUTCHAR_PROTOTYPE int __io_putchar(int ch)
#else
	#define PUTCHAR_PROTOTYPE int fputc(int ch, FILE *f)
#endif
/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */
PUTCHAR_PROTOTYPE
{
	if(HAL_UART_Transmit(&huart2, (uint8_t*)&ch, 1, HAL_MAX_DELAY)!= HAL_OK)
		Error_Handler();
	return ch;
}
/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_USART2_UART_Init();
  /* USER CODE BEGIN 2 */

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  float signal_in[NUM_SAMPLES];
  float sample_instance=0.02/15.0, x=0.0, w=2*PI*50, wc=2*PI*1000;
  for(uint16_t i=0; i<NUM_SAMPLES; i++)
  {
      //Signal s(t)=A(t)cos(wt);
      signal_in[i] = (1+cos(w * x))*cos(wc * x);
      x = x+sample_instance;
  }
  float noise[NUM_SAMPLES] = {0.5785, 0.39374, -0.458, 0.0842, 0.93934, 0.428976, 0.005775, -0.63215, -0.3497, 0.306, 0.20854, 0.09685, 0.3879, -0.685, 0.0588, 0.212686, 0.699, -0.35, -0.0493, -0.828, 0.6035, 0.6317, 0.522, 0.586766, -0.8474, 0.34654, 0.95, 0.744, -0.0805, -0.545, 0.31262, 0.826958, 0.89656, -0.65085, -0.19565, 0.638275, 0.0451, -0.5636, 0.57904, 0.99762, -0.9804, -0.7496, -0.7606, -0.81, 0.6774, -0.1525, -0.38063, -0.6382, 0.0928, 0.20225, -0.534, -0.1325, -0.422, 0.14395, -0.451366, -0.3263, -0.19875, -0.54265, 0.394, -0.20975, 0.04808, 0.79142, -0.6, 0.55366, 0.698, -0.25967, -0.118357, -0.96925, 0.5077, 0.98987, -0.3796, 0.17878, 0.361869, 0.4229, 0.2027, -0.0292, 0.10795, 0.7895, 0.86, -0.746, 0.4347, 0.53725, 0.89, 0.6454, 0.31326, 0.908, 0.798675, -0.105, -0.4105, -0.07495, -0.81538, -0.806, -0.663, -0.4586, 0.9565, 0.0236, 0.9276, -0.63184, 0.73363, 0.357, -0.226, -0.268, -0.59524, -0.8536, 0.4953, 0.867, -0.64185, -0.3721, 0.788, 0.1023, -0.517584, -0.5106, 0.1465, -0.844, 0.235, -0.686, 0.59725, 0.34769, 0.95, 0.378, 0.2136, -0.33373, 0.3675, 0.127468, 0.1903, 0.243, 0.5635, 0.705, 0.818, -0.64868, 0.88165, -0.8953, 0.19548, -0.4534, -0.3392, 0.4114, 0.86807, 0.09248, 0.4793, -0.1334, 0.0365, -0.5725, 0.6814, -0.4114, -0.36775, 0.69, -0.06527, -0.6503, -0.49028, -0.835, -0.25, -0.6134, 0.0575, -0.02924, 0.95353, 0.7725, 0.592, -0.62913, -0.205, 0.99272, 0.6041, -0.171, 0.887, -0.1848, -0.216, -0.6175, -0.0583, 0.271, -0.07976, 0.552, -0.6275, -0.3235, -0.3564, -0.015263, 0.7603, -0.005, 0.29775, 0.24612, 0.6891, -0.2185, -0.657, -0.2435, -0.74324, 0.695, -0.21884, 0.9507, -0.07213, -0.45135, 0.8767, 0.574, 0.105, -0.78034, -0.27074, -0.214, -0.61207, 0.73135, -0.7984, 0.89, 0.6705, 0.781, -0.00621, 0.7848, -0.086, 0.72515, 0.7085, 0.3474, 0.1389, 0.5326, -0.46838, -0.55665, 0.226349, 0.78664, 0.235, 0.349, 0.86, -0.177, -0.63, 0.093655, -0.1685, 0.585, 0.179, -0.120, 0.66135, -0.51, -0.6258, 0.344, -0.9912, -0.03857, 0.7515, 0.264, -0.2777, 0.985, -0.094337, -0.77777, 0.5269, -0.94435, 0.2363, -0.4678, -0.202777, -0.280643, 0.97705, -0.7225, 0.180, -0.3444, -0.131, -0.41, 0.36425, 0.589, -0.175, -0.5534, -0.3925, -0.62, -0.3, 0.3405, 0.7479, 0.1931, -0.8089, 0.1866, 0.731, 0.6375, -0.433, -0.733, -0.45, -0.525, 0.095, -0.85275, -0.89563, 0.5525, -0.355, 0.344, 0.6664, -0.648, 0.3455, 0.215, 0.86, -0.65, -0.1391, 0.0710, 0.4625, 0.351, -0.6053, 0.654, -0.373, -0.0942, 0.741, -0.415, -0.99865, 0.99, 0.925, 0.19, 0.263, -0.95, 0.35, 0.1295, -0.765, 0.145, -0.0195, -0.9685, 0.235, -0.014, -0.876, -0.21853, 0.9005, -0.34726, 0.417, -0.463, -0.933, -0.051, -0.6585, 0.1473,-0.15615, 0.92635, 0.912, 0.569, -0.88, 0.26, -0.95, 0.3563, 0.4167, 0.118, 0.724, 0.2475, 0.63, -0.2349, 0.94, 0.9277, -0.547, 0.6757, -0.2176, -0.14, -0.45, -0.6552, -0.0964, -0.99, -0.938, -0.2763, -0.7565, -0.5584, 0.922, -0.752, 0.32206, 0.890, -0.4905, 0.4180, 0.72458, -0.859, 0.16, -0.438, 0.512, 0.535, 0.4025, -0.2805, 0.20635, -0.20776, -0.49,-0.83, 0.965, 0.98, -0.75, -0.95, 0.69, 0.017, -0.764, 0.316, -0.01, -0.938, -0.71353, -0.812, -0.84, -0.3366, -0.716, 0.586, -0.139, -0.3885, -0.0723, -0.6623, 0.74626, 0.1234, -0.639, -0.307, 0.093, -0.27, -0.6925, -0.48, -0.61, -0.638, 0.4325, -0.2006, -0.145, 0.807, 0.314, -0.904, 0.5534, 0.027, 0.55, 0.002, 0.275, -0.588, -0.827, 0.8483, 0.09775, -0.608, 0.04575, 0.9452, -0.71635, -0.0913, 0.454, -0.2235, 0.83, 0.0198, -0.2375, -0.61, -0.028, 0.229, 0.73, 0.985, 0.4058,0.984, -0.012, -0.565, 0.8175, -0.4225, -0.7185, -0.672, -0.675, 0.625, -0.714, 0.9536, 0.09334, -0.195, 0.636, 0.625, 0.5079, -0.6362, -0.54, 0.196, -0.14, 0.237, 0.63, 0.334, -0.27, 0.085, -0.81, -0.835, 0.0723, -0.063, -0.2, 0.0275, -0.655, 0.637, -0.75, -0.25, -0.47, 0.438, 0.19, 0.2775, -0.832, -0.4196, -0.329, 0.859, 0.0322, 0.895, -0.428, 0.80, -0.4576, 0.51, 0.0104, 0.204, 0.83, -0.508, 0.204, -0.55, -0.84, 0.485, 0.53, -0.06, -0.6685, -0.1664, -0.596, -0.4875, -0.003, 0.59, 0.965, -0.276, 0.808, -0.59, -0.545, 0.085, 0.38, 0.753, 0.5375, -0.325, -0.8585, 0.98, -0.035, 0.0305, 0.567, -0.91657, -0.76, 0.37, -0.985, -0.505, -0.177, 0.635, -0.4606, 0.0785, -0.695, -0.684, 0.773, 0.49, 0.476, 0.083, -0.95, -0.947, -0.9566, 0.8565, 0.125, -0.165, -0.25, 0.74, 0.6, 0.506, 0.686, -0.788, -0.442, -0.175, 0.219, 0.225, 0.676, -0.25, -0.53, 0.285, -0.784, -0.973, 0.795, 0.5075, -0.586, -0.60825, -0.498, 0.576, 0.869, 0.65, -0.4, -0.13, 0.905, 0.96, -0.295, 0.048, 0.765, 0.327, -0.837, -0.57, 0.486, 0.25, 0.517, -0.65, -0.83, -0.307, -0.5514, 0.96, 0.032, 0.169, -0.42, -0.573, -0.30, -0.43, -0.0425, -0.5, -0.78, -0.784, -0.26, 0.115, -0.9, -0.19, -0.58, 0.9, 0.274, 0.282, 0.08, -0.8, -0.4534, 0.9716, 0.7035, 0.25, -0.25, -0.28, -0.44, 0.579, 0.1459, -0.5875, 0.979, -0.956, -0.8977, -0.49, 0.34, 0.298, -0.84, 0.846, -0.50864, -0.928, -0.83, 0.93, 0.4582, 0.47, 0.63, 0.6567, -0.8427, 0.541, 0.644, 0.24, -0.33, -0.86, 0.78, -0.5675, -0.0044, -0.6935, -0.2404, 0.09, 0.3, -0.00536, 0.46, 0.965, -0.653, -0.15, 0.31, 0.81, 0.4054, 0.668, -0.15, -0.6134, -0.67, 0.844, -0.60, -0.84, -0.114, -0.9, -0.74, -0.61, 0.9077, 0.165, 0.75, -0.0725, -0.24, -0.347, 0.422, -0.3, 0.968, 0.586, -0.6914, -0.65, 0.324, 0.178, -0.4826, -0.482, 0.485, -0.54, 0.635, -0.2, 0.47, -0.73, -0.941, 0.613, 0.5936, -0.6635, 0.498, 0.77, 0.827, -0.58, 0.8375, 0.675, 0.73424, -0.4416, -0.92, -0.65, -0.6235, 0.6426, 0.754, 0.692, 0.872, -0.7605, -0.242, 0.002, 0.0086, -0.11, 0.44, -0.0212, 0.715, -0.973, -0.7625, 0.92, 0.9984, -0.7215, 0.668, -0.277, -0.17, -0.5735, -0.84, -0.352, -0.225, -0.19, -0.218, -0.025, -0.0064, -0.34, 0.695, -0.69, -0.55, -0.003, -0.22, -0.2653, 0.8425, 0.4718, -0.94, 0.60, 0.2715, -0.023, 0.0337, -0.82, 0.92, -0.396, -0.99, -0.963, -0.68, 0.555, 0.33, 0.855, -0.179, -0.795, -0.2657, 0.199, 0.40, 0.33, -0.496, -0.574, 0.378, 0.84, 0.763, 0.2, -0.83, -0.86, 0.95, -0.42, -0.762, 0.685, 0.297, 0.425, 0.88, -0.675, -0.926, -0.27};
  float received_signal[NUM_SAMPLES];
      //Received signal r(t) = signal s(t) + noise n(t)
  float *s = &signal_in[0], *n = &noise[0], *r = &received_signal[0];
  for(uint16_t i=0; i<15; i++)
	  arm_add_f32(s+(i*50), n+(i*50), r+(i*50), 50);



  /* Matched Filter */
  float impulse_response[NUM_SAMPLES], filter_out[1499];
  //Schwarz inequality
  //h(t)=s*(T-t) (conjugate)
  for(uint16_t k=0; k<NUM_SAMPLES; k++)
      impulse_response[k] = signal_in[NUM_SAMPLES-k-1];
  //Filter output y(t)=r(t) * h(t) (convolution)
  arm_conv_f32((float*)&received_signal[0], NUM_SAMPLES, (float*)&impulse_response[0], NUM_SAMPLES, (float*)&filter_out[0]);



  /* Compressed Sensing */
  //Generating the sparse signal
  float sparse[150], A[150];

  //Initialization of sparse vector
  for(uint8_t i=0; i<150; i++)
  {	  sparse[i] = 0;
	  A[i] = expf(-sqrtf(i));  }
  for(uint8_t i=0,j=0; i<150; i++,j=j+10)
	  sparse[i] = filter_out[j] * A[i];

  float h[601] = {-1.07238639,  0.52240151,  0.42724375, -0.6909376 ,  0.25051331,  0.11691955, -0.09449603,  0.00812118,  0.0018768 , -0.10096553, 0.13525453,  0.23684425, -0.70113151,  0.45657451,  0.49659067,  -1.06553147,  0.52808798,  0.42207683, -0.69056418,  0.25094881,  0.11628652, -0.09442178,  0.00816443,  0.00177824, -0.10095512,  0.13533436,  0.23670423, -0.70113304,  0.45680497,  0.49632434, -1.06552436,  0.52834242,  0.42184387, -0.69054988,  0.25106153,  0.11621492, -0.09441412,  0.00816426,  0.00177647, -0.10095939,  0.13540576,  0.23658523, -0.70113822,  0.45703339,  0.49606331,  -1.06551821,  0.52859626,  0.4216124 , -0.69053584,  0.25117407, 0.11614377, -0.09440656,  0.00816403,  0.00177487, -0.1009637 ,  0.13547713,  0.23646625, -0.70114335,  0.45726175,  0.49580226,  -1.06551196,  0.52885005,  0.4213809 , -0.69052174,  0.25128658,  0.11607263, -0.09439899,  0.0081638 ,  0.00177326, -0.100968  ,  0.1355485 ,  0.23634726, -0.70114842,  0.45749008,  0.49554116, -1.06550563,  0.52910379,  0.42114937, -0.69050759,  0.25139906,  0.11600148, -0.09439141,  0.00816356,  0.00177166, -0.10097229,  0.13561985,  0.23622824, -0.70115343,  0.45771838,  0.49528002,  -1.0654992 ,  0.52935748,  0.42091781, -0.69049337,  0.25151151,  0.11593032, -0.09438383,  0.00816333,  0.00177005, -0.10097657,   0.1356912 ,  0.23610919, -0.70115838,  0.45794663,  0.49501883, -1.06549268,  0.52961113,  0.42068621, -0.6904791 ,  0.25162394, 0.11585915, -0.09437624,  0.0081631 ,  0.00176844, -0.10098084,  0.13576254,  0.23599012, -0.70116327,  0.45817485,  0.4947576 , -1.06548607,  0.52986473,  0.42045458, -0.69046476,  0.25173635,   0.11578798, -0.09436863,  0.00816286,  0.00176683, -0.1009851 ,  0.13583387,  0.23587103, -0.7011681 ,  0.45840304,  0.49449633,  -1.06547936,  0.53011828,  0.42022291, -0.69045037,  0.25184873,  0.1157168 , -0.09436103,  0.00816262,  0.00176522, -0.10098936,  0.13590519,  0.23575191, -0.70117287,  0.45863119,  0.49423501, -1.06547257,  0.53037178,  0.41999121, -0.69043592,  0.25196108,  0.11564562, -0.09435341,  0.00816238,  0.00176361, -0.1009936 ,  0.1359765 ,  0.23563277, -0.70117758,  0.4588593 ,  0.49397364, -1.06546568,  0.53062524,  0.41975948, -0.6904214 ,  0.25207341,  0.11557442, -0.09434578,  0.00816214,  0.00176199, -0.10099784,  0.13604781,  0.2355136 , -0.70118223,  0.45908737,  0.49371223,  -1.0654587 ,  0.53087865,  0.41952772, -0.69040683,  0.25218571,  0.11550323, -0.09433815,  0.0081619 ,  0.00176038, -0.10100207,   0.1361191 ,  0.23539441, -0.70118681,  0.45931541,  0.49345078,  -1.06545162,  0.53113201,  0.41929592, -0.6903922 ,  0.25229799,  0.11543202, -0.09433051,  0.00816166,  0.00175877, -0.10100629, 0.13619039,  0.2352752 , -0.70119134,  0.45954341,  0.49318928, -1.06544446,  0.53138532,  0.41906409, -0.6903775 ,  0.25241024,  0.11536081, -0.09432286,  0.00816141,  0.00175715, -0.1010105 ,  0.13626167,  0.23515596, -0.7011958 ,  0.45977137,  0.49292774, -1.0654372 ,  0.53163859,  0.41883222, -0.69036275,  0.25252246,  0.11528959, -0.0943152 ,  0.00816117,  0.00175553, -0.1010147 ,  0.13633294,  0.23503669, -0.70120021,  0.4599993 ,  0.49266615, -1.06542985,  0.5318918 ,  0.41860033, -0.69034794,  0.25263466, 0.11521837, -0.09430754,  0.00816092,  0.00175392, -0.1010189 ,   0.13640421,  0.23491741, -0.70120455,  0.46022718,  0.49240452,  -1.06542241,  0.53214498,  0.4183684 , -0.69033307,  0.25274683,  0.11514714, -0.09429986,  0.00816067,  0.0017523 , -0.10102308,  0.13647546,  0.23479809, -0.70120884,  0.46045504,  0.49214285,  -1.06541487,  0.5323981 ,  0.41813643, -0.69031814,  0.25285898,  0.1150759 , -0.09429218,  0.00816042,  0.00175068, -0.10102726,  0.13654671,  0.23467876, -0.70121306,  0.46068285,  0.49188113,  -1.06540725,  0.53265117,  0.41790443, -0.69030315,  0.2529711 ,  0.11500466, -0.0942845 ,  0.00816017,  0.00174906, -0.10103143,  0.13661795,  0.2345594 , -0.70121722,  0.46091063,  0.49161937,  -1.06539953,  0.5329042 ,  0.4176724 , -0.6902881 ,  0.2530832 ,  0.11493341, -0.0942768 ,  0.00815992,  0.00174744, -0.10103559,  0.13668918,  0.23444001, -0.70122132,  0.46113837,  0.49135756,  -1.06539172,  0.53315718,  0.41744034, -0.69027299,  0.25319527,  0.11486216, -0.09426909,  0.00815966,  0.00174582, -0.10103974,   0.1367604 ,  0.2343206 , -0.70122536,  0.46136608,  0.49109571, -1.06538382,  0.53341011,  0.41720824, -0.69025782,  0.25330731,  0.11479089, -0.09426138,  0.00815941,  0.00174419, -0.10104388,  0.13683162,  0.23420117, -0.70122934,  0.46159375,  0.49083381, -1.06537582,  0.533663  ,  0.41697612, -0.69024259,  0.25341933,  0.11471962, -0.09425366,  0.00815915,  0.00174257, -0.10104801,  0.13690282,  0.23408171, -0.70123326,  0.46182138,  0.49057188, -1.06536773,  0.53391583,  0.41674395, -0.69022731,  0.25353133,  0.11464835, -0.09424593,  0.00815889,  0.00174094, -0.10105214,  0.13697402,  0.23396223, -0.70123712,  0.46204897,  0.49030989,  -1.06535956,  0.53416862,  0.41651176, -0.69021196,  0.25364329, 0.11457707, -0.0942382 ,  0.00815863,  0.00173932, -0.10105626, 0.13704521,  0.23384272, -0.70124091,  0.46227653,  0.49004786, -1.06535128,  0.53442136,  0.41627953, -0.69019655,  0.25375523, 0.11450578, -0.09423045,  0.00815837,  0.00173769, -0.10106036,  0.13711639,  0.23372319, -0.70124465,  0.46250405,  0.48978579,  -1.06534292,  0.53467406,  0.41604727, -0.69018108,  0.25386715,  0.11443449, -0.0942227 ,  0.00815811,  0.00173606, -0.10106446, 0.13718756,  0.23360364, -0.70124833,  0.46273153,  0.48952368, -1.06533446,  0.5349267 ,  0.41581497, -0.69016556,  0.25397904, 0.11436319, -0.09421494,  0.00815785,  0.00173444, -0.10106855,  0.13725873,  0.23348406, -0.70125194,  0.46295897,  0.48926152, -1.06532592,  0.5351793 ,  0.41558265, -0.69014997,  0.2540909 ,  0.11429188, -0.09420717,  0.00815758,  0.00173281, -0.10107264,  0.13732988,  0.23336445, -0.7012555 ,  0.46318638,  0.48899932,  -1.06531728,  0.53543185,  0.41535029, -0.69013433,  0.25420274,  0.11422057, -0.0941994 ,  0.00815731,  0.00173118, -0.10107671, 0.13740103,  0.23324483, -0.70125899,  0.46341375,  0.48873707, -1.06530854,  0.53568435,  0.41511789, -0.69011862,  0.25431455,  0.11414925, -0.09419161,  0.00815705,  0.00172954, -0.10108077, 0.13747217,  0.23312517, -0.70126242,  0.46364109,  0.48847478, -1.06529972,  0.5359368 ,  0.41488547, -0.69010286,  0.25442634, 0.11407792, -0.09418382,  0.00815678,  0.00172791, -0.10108483,  0.1375433 ,  0.2330055 , -0.7012658 ,  0.46386838,  0.48821244, -1.0652908 ,  0.53618921,  0.41465301, -0.69008703,  0.2545381 ,  0.11400659, -0.09417602,  0.0081565 ,  0.00172628, -0.10108888, 0.13761442,  0.2328858 , -0.70126911,  0.46409564,  0.48795006, -1.06528179,  0.53644156,  0.41442052, -0.69007115,  0.25464984,  0.11393525, -0.09416821,  0.00815623,  0.00172464, -0.10109292, 0.13768553,  0.23276607, -0.70127236,  0.46432286,  0.48768764, -1.06527269,  0.53669387,  0.41418799, -0.69005521,  0.25476154, 0.11386391, -0.0941604 ,  0.00815596,  0.00172301, -0.10109695,  0.13775664,  0.23264632, -0.70127555,  0.46455005,  0.48742518, -1.0652635 ,  0.53694613,  0.41395544, -0.69003921,  0.25487323,  0.11379256, -0.09415257,  0.00815568,  0.00172137, -0.10110097,  0.13782774,  0.23252655, -0.70127868,  0.4647772 ,  0.48716267, -1.06525421,  0.53719835,  0.41372285, -0.69002314,  0.25498488,  0.1137212 , -0.09414474,  0.00815541,  0.00171974, -0.10110498,  0.13789882,  0.23240676, -0.70128175,  0.46500431,  0.48690011, -1.06524484,  0.53745051,  0.41349022, -0.69000702,  0.25509651,  0.11364984, -0.0941369 ,  0.00815513,  0.0017181 , -0.10110898, 0.1379699 ,  0.23228694, -0.70128476,  0.46523138,  0.48663751, -1.06523537,  0.53770263,  0.41325757, -0.68999084,  0.25520812,  0.11357847, -0.09412906,  0.00815485,  0.00171646, -0.10111298, 0.13804098,  0.23216709, -0.7012877 ,  0.46545842,  0.48637487, -1.06522581};
  float output[NUM_SAMPLES], final_out[NUM_SAMPLES];
  arm_conv_f32((float*)&sparse[0], 150, (float*)&h[0], 601, (float*)&output[0]);
  arm_scale_f32((float*)&output[0],0.1,(float*)&final_out[0],750);


  /* Printing the values */
//  // Reference signal
//     x=0.0;
//     printf("REFERENCE SIGNAL\n");
//     for(int i=0; i<750; i++)
//     {   printf("%f, %f\n",x,signal_in[i]);
//   	  	 x = x+sample_instance;
//         HAL_Delay(10);	}
//     printf("\n");

//  // Received signal
//     x=0.0;
//     printf("RECEIVED SIGNAL\n");
//     for(int i=0; i<750; i++)
//     {   printf("Received signal at %f us: %f\n",x,received_signal[i]);
//   	  	 x = x+sample_instance;
//         HAL_Delay(10);	}
//     printf("\n");

 // Final output
    x=0.0;
    printf("\nOUTPUT SIGNAL\n");
    for(int i=0; i<750; i++)
    {   printf("Output signal at %f us: %f\n",x,final_out[i]);
  	  	 x = x+sample_instance;
        HAL_Delay(10);	}
    printf("\n");
	
 // Performance Comparison
    float *in = &signal_in[0], *out = &final_out[0], snr;
    for(uint8_t i=0;i<15;i++)
    snr = fabsf(arm_snr_f32(in+(i*50), out+(i*50), 50));
    printf("Error: %f\n",snr);

  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  __HAL_RCC_PWR_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);
  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI;
  RCC_OscInitStruct.HSIState = RCC_HSI_ON;
  RCC_OscInitStruct.HSICalibrationValue = RCC_HSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSI;
  RCC_OscInitStruct.PLL.PLLM = 8;
  RCC_OscInitStruct.PLL.PLLN = 100;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
  RCC_OscInitStruct.PLL.PLLQ = 4;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }
  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV2;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_3) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief USART2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_USART2_UART_Init(void)
{

  /* USER CODE BEGIN USART2_Init 0 */

  /* USER CODE END USART2_Init 0 */

  /* USER CODE BEGIN USART2_Init 1 */

  /* USER CODE END USART2_Init 1 */
  huart2.Instance = USART2;
  huart2.Init.BaudRate = 9600;
  huart2.Init.WordLength = UART_WORDLENGTH_8B;
  huart2.Init.StopBits = UART_STOPBITS_1;
  huart2.Init.Parity = UART_PARITY_NONE;
  huart2.Init.Mode = UART_MODE_TX_RX;
  huart2.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  huart2.Init.OverSampling = UART_OVERSAMPLING_16;
  if (HAL_UART_Init(&huart2) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN USART2_Init 2 */

  /* USER CODE END USART2_Init 2 */

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOC_CLK_ENABLE();
  __HAL_RCC_GPIOH_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();

}

/* USER CODE BEGIN 4 */

/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */

/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/
