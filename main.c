/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * <h2><center>&copy; Copyright (c) 2021 STMicroelectronics.
  * All rights reserved.</center></h2>
  *
  * This software component is licensed by ST under Ultimate Liberty license
  * SLA0044, the "License"; You may not use this file except in compliance with
  * the License. You may obtain a copy of the License at:
  *                             www.st.com/SLA0044
  *
  ******************************************************************************
  */
#define ARM_MATH_CM4
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "arm_math.h"
#include "math_helper.h"
#include <stdint.h>
#include <math.h>
#include <stdio.h>
#include <stdlib.h>
#include <time.h>
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
#define NUM_SAMPLES 750
//#define BLINKING_RATE_MS 500 // Blinking rate in milliseconds
/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
UART_HandleTypeDef huart2;

/* USER CODE BEGIN PV */

/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_USART2_UART_Init(void);
/* USER CODE BEGIN PFP */
#ifdef __GNUC__
	#define PUTCHAR_PROTOTYPE int __io_putchar(int ch)
#else
	#define PUTCHAR_PROTOTYPE int fputc(int ch, FILE *f)
#endif

void call();
/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */
PUTCHAR_PROTOTYPE
{
	if(HAL_UART_Transmit(&huart2, (uint8_t*)&ch, 1, HAL_MAX_DELAY)!= HAL_OK)
		Error_Handler();
	return ch;
}

/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */
//	call();
  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_USART2_UART_Init();
  /* USER CODE BEGIN 2 */

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  float signal_in[NUM_SAMPLES];
  float sample_instance=0.02/15.0, x=0.0, w=2*PI*50, wc=2*PI*1000;
  srand(time(0));
  for(uint16_t i=0; i<NUM_SAMPLES; i++)
  {
      //Signal s(t)=A(t)cos(wt);
      signal_in[i] = (1+cos(w * x))*cos(wc * x);
      x = x+sample_instance;
  }
  //noise[i] = ((float)rand()/(float)RAND_MAX) * 2.0 - 1.0;
  float noise[NUM_SAMPLES] = {0.5785, 0.39374, -0.458, 0.0842, 0.93934, 0.428976, 0.005775, -0.63215, -0.3497, 0.306, 0.20854, 0.09685, 0.3879, -0.685, 0.0588, 0.212686, 0.699, -0.35, -0.0493, -0.828, 0.6035, 0.6317, 0.522, 0.586766, -0.8474, 0.34654, 0.95, 0.744, -0.0805, -0.545, 0.31262, 0.826958, 0.89656, -0.65085, -0.19565, 0.638275, 0.0451, -0.5636, 0.57904, 0.99762, -0.9804, -0.7496, -0.7606, -0.81, 0.6774, -0.1525, -0.38063, -0.6382, 0.0928, 0.20225, -0.534, -0.1325, -0.422, 0.14395, -0.451366, -0.3263, -0.19875, -0.54265, 0.394, -0.20975, 0.04808, 0.79142, -0.6, 0.55366, 0.698, -0.25967, -0.118357, -0.96925, 0.5077, 0.98987, -0.3796, 0.17878, 0.361869, 0.4229, 0.2027, -0.0292, 0.10795, 0.7895, 0.86, -0.746, 0.4347, 0.53725, 0.89, 0.6454, 0.31326, 0.908, 0.798675, -0.105, -0.4105, -0.07495, -0.81538, -0.806, -0.663, -0.4586, 0.9565, 0.0236, 0.9276, -0.63184, 0.73363, 0.357, -0.226, -0.268, -0.59524, -0.8536, 0.4953, 0.867, -0.64185, -0.3721, 0.788, 0.1023, -0.517584, -0.5106, 0.1465, -0.844, 0.235, -0.686, 0.59725, 0.34769, 0.95, 0.378, 0.2136, -0.33373, 0.3675, 0.127468, 0.1903, 0.243, 0.5635, 0.705, 0.818, -0.64868, 0.88165, -0.8953, 0.19548, -0.4534, -0.3392, 0.4114, 0.86807, 0.09248, 0.4793, -0.1334, 0.0365, -0.5725, 0.6814, -0.4114, -0.36775, 0.69, -0.06527, -0.6503, -0.49028, -0.835, -0.25, -0.6134, 0.0575, -0.02924, 0.95353, 0.7725, 0.592, -0.62913, -0.205, 0.99272, 0.6041, -0.171, 0.887, -0.1848, -0.216, -0.6175, -0.0583, 0.271, -0.07976, 0.552, -0.6275, -0.3235, -0.3564, -0.015263, 0.7603, -0.005, 0.29775, 0.24612, 0.6891, -0.2185, -0.657, -0.2435, -0.74324, 0.695, -0.21884, 0.9507, -0.07213, -0.45135, 0.8767, 0.574, 0.105, -0.78034, -0.27074, -0.214, -0.61207, 0.73135, -0.7984, 0.89, 0.6705, 0.781, -0.00621, 0.7848, -0.086, 0.72515, 0.7085, 0.3474, 0.1389, 0.5326, -0.46838, -0.55665, 0.226349, 0.78664, 0.235, 0.349, 0.86, -0.177, -0.63, 0.093655, -0.1685, 0.585, 0.179, -0.120, 0.66135, -0.51, -0.6258, 0.344, -0.9912, -0.03857, 0.7515, 0.264, -0.2777, 0.985, -0.094337, -0.77777, 0.5269, -0.94435, 0.2363, -0.4678, -0.202777, -0.280643, 0.97705, -0.7225, 0.180, -0.3444, -0.131, -0.41, 0.36425, 0.589, -0.175, -0.5534, -0.3925, -0.62, -0.3, 0.3405, 0.7479, 0.1931, -0.8089, 0.1866, 0.731, 0.6375, -0.433, -0.733, -0.45, -0.525, 0.095, -0.85275, -0.89563, 0.5525, -0.355, 0.344, 0.6664, -0.648, 0.3455, 0.215, 0.86, -0.65, -0.1391, 0.0710, 0.4625, 0.351, -0.6053, 0.654, -0.373, -0.0942, 0.741, -0.415, -0.99865, 0.99, 0.925, 0.19, 0.263, -0.95, 0.35, 0.1295, -0.765, 0.145, -0.0195, -0.9685, 0.235, -0.014, -0.876, -0.21853, 0.9005, -0.34726, 0.417, -0.463, -0.933, -0.051, -0.6585, 0.1473,-0.15615, 0.92635, 0.912, 0.569, -0.88, 0.26, -0.95, 0.3563, 0.4167, 0.118, 0.724, 0.2475, 0.63, -0.2349, 0.94, 0.9277, -0.547, 0.6757, -0.2176, -0.14, -0.45, -0.6552, -0.0964, -0.99, -0.938, -0.2763, -0.7565, -0.5584, 0.922, -0.752, 0.32206, 0.890, -0.4905, 0.4180, 0.72458, -0.859, 0.16, -0.438, 0.512, 0.535, 0.4025, -0.2805, 0.20635, -0.20776, -0.49,-0.83, 0.965, 0.98, -0.75, -0.95, 0.69, 0.017, -0.764, 0.316, -0.01, -0.938, -0.71353, -0.812, -0.84, -0.3366, -0.716, 0.586, -0.139, -0.3885, -0.0723, -0.6623, 0.74626, 0.1234, -0.639, -0.307, 0.093, -0.27, -0.6925, -0.48, -0.61, -0.638, 0.4325, -0.2006, -0.145, 0.807, 0.314, -0.904, 0.5534, 0.027, 0.55, 0.002, 0.275, -0.588, -0.827, 0.8483, 0.09775, -0.608, 0.04575, 0.9452, -0.71635, -0.0913, 0.454, -0.2235, 0.83, 0.0198, -0.2375, -0.61, -0.028, 0.229, 0.73, 0.985, 0.4058,0.984, -0.012, -0.565, 0.8175, -0.4225, -0.7185, -0.672, -0.675, 0.625, -0.714, 0.9536, 0.09334, -0.195, 0.636, 0.625, 0.5079, -0.6362, -0.54, 0.196, -0.14, 0.237, 0.63, 0.334, -0.27, 0.085, -0.81, -0.835, 0.0723, -0.063, -0.2, 0.0275, -0.655, 0.637, -0.75, -0.25, -0.47, 0.438, 0.19, 0.2775, -0.832, -0.4196, -0.329, 0.859, 0.0322, 0.895, -0.428, 0.80, -0.4576, 0.51, 0.0104, 0.204, 0.83, -0.508, 0.204, -0.55, -0.84, 0.485, 0.53, -0.06, -0.6685, -0.1664, -0.596, -0.4875, -0.003, 0.59, 0.965, -0.276, 0.808, -0.59, -0.545, 0.085, 0.38, 0.753, 0.5375, -0.325, -0.8585, 0.98, -0.035, 0.0305, 0.567, -0.91657, -0.76, 0.37, -0.985, -0.505, -0.177, 0.635, -0.4606, 0.0785, -0.695, -0.684, 0.773, 0.49, 0.476, 0.083, -0.95, -0.947, -0.9566, 0.8565, 0.125, -0.165, -0.25, 0.74, 0.6, 0.506, 0.686, -0.788, -0.442, -0.175, 0.219, 0.225, 0.676, -0.25, -0.53, 0.285, -0.784, -0.973, 0.795, 0.5075, -0.586, -0.60825, -0.498, 0.576, 0.869, 0.65, -0.4, -0.13, 0.905, 0.96, -0.295, 0.048, 0.765, 0.327, -0.837, -0.57, 0.486, 0.25, 0.517, -0.65, -0.83, -0.307, -0.5514, 0.96, 0.032, 0.169, -0.42, -0.573, -0.30, -0.43, -0.0425, -0.5, -0.78, -0.784, -0.26, 0.115, -0.9, -0.19, -0.58, 0.9, 0.274, 0.282, 0.08, -0.8, -0.4534, 0.9716, 0.7035, 0.25, -0.25, -0.28, -0.44, 0.579, 0.1459, -0.5875, 0.979, -0.956, -0.8977, -0.49, 0.34, 0.298, -0.84, 0.846, -0.50864, -0.928, -0.83, 0.93, 0.4582, 0.47, 0.63, 0.6567, -0.8427, 0.541, 0.644, 0.24, -0.33, -0.86, 0.78, -0.5675, -0.0044, -0.6935, -0.2404, 0.09, 0.3, -0.00536, 0.46, 0.965, -0.653, -0.15, 0.31, 0.81, 0.4054, 0.668, -0.15, -0.6134, -0.67, 0.844, -0.60, -0.84, -0.114, -0.9, -0.74, -0.61, 0.9077, 0.165, 0.75, -0.0725, -0.24, -0.347, 0.422, -0.3, 0.968, 0.586, -0.6914, -0.65, 0.324, 0.178, -0.4826, -0.482, 0.485, -0.54, 0.635, -0.2, 0.47, -0.73, -0.941, 0.613, 0.5936, -0.6635, 0.498, 0.77, 0.827, -0.58, 0.8375, 0.675, 0.73424, -0.4416, -0.92, -0.65, -0.6235, 0.6426, 0.754, 0.692, 0.872, -0.7605, -0.242, 0.002, 0.0086, -0.11, 0.44, -0.0212, 0.715, -0.973, -0.7625, 0.92, 0.9984, -0.7215, 0.668, -0.277, -0.17, -0.5735, -0.84, -0.352, -0.225, -0.19, -0.218, -0.025, -0.0064, -0.34, 0.695, -0.69, -0.55, -0.003, -0.22, -0.2653, 0.8425, 0.4718, -0.94, 0.60, 0.2715, -0.023, 0.0337, -0.82, 0.92, -0.396, -0.99, -0.963, -0.68, 0.555, 0.33, 0.855, -0.179, -0.795, -0.2657, 0.199, 0.40, 0.33, -0.496, -0.574, 0.378, 0.84, 0.763, 0.2, -0.83, -0.86, 0.95, -0.42, -0.762, 0.685, 0.297, 0.425, 0.88, -0.675, -0.926, -0.27};
  float received_signal[NUM_SAMPLES] = {0};
      //Received signal r(t) = signal s(t) + noise n(t)
  float *s = &signal_in[0], *n = &noise[0], *r = &received_signal[0];
  for(uint16_t i=0; i<15; i++)
	  arm_add_f32(s+(i*50), n+(i*50), r+(i*50), 50);



  /* Matched Filter */
  float impulse_response[NUM_SAMPLES]={0}, filter_out[1499]={0};
  //Schwarz inequality
  //h(t)=s*(T-t) (conjugate)
  for(uint16_t k=0; k<NUM_SAMPLES; k++)
      impulse_response[k] = signal_in[NUM_SAMPLES-k-1];
  //Filter output y(t)=r(t) * h(t) (convolution)
  arm_conv_f32((float*)&received_signal[0], NUM_SAMPLES, (float*)&impulse_response[0], NUM_SAMPLES, (float*)&filter_out[0]);



  /* Compressed Sensing */
  //Generating the sparse signal
  float sparse[150];
  arm_fir_sparse_instance_f32 S;
  int32_t tap_delay[150] = {0,10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190,200,210,220,230,240,250,260,270,280,290,300,310,320,330,340,350,360,370,380,390,400,410,420,430,440,450,460,470,480,490,500,510,520,530,540,550,560,570,580,590,600,610,620,630,640,650,660,670,680,690,700,710,720,730,740,750,760,770,780,790,800,810,820,830,840,850,860,870,880,890,900,910,920,930,940,950,960,970,980,990,1000,1010,1020,1030,1040,1050,1060,1070,1080,1090,1100,1110,1120,1130,1140,1150,1160,1170,1180,1190,1200,1210,1220,1230,1240,1250,1260,1270,1280,1290,1300,1310,1320,1330,1340,1350,1360,1370,1380,1390,1400,1410,1420,1430,1440,1450,1460,1470,1480,1490};
  float coef[150] = {-1.42235358e+01, -1.34327984e+00, -9.79377718e-02, -3.44828537e-01, -1.40404069e-01, -3.74485672e-02, -1.32270464e-01, -4.93966505e-02, -1.55026408e-02, -4.52253065e-02, -1.38190695e-02, -6.16531731e-03, -1.59900616e-02, -5.28666474e-03, -6.51862427e-04,  1.00493777e-03, -2.27398633e-03,  1.13619332e-03,  2.21490826e-03, -4.18794498e-03,	        1.59458582e-03,  1.62878096e-03, -2.86584757e-03,  8.48455020e-04,  5.66398560e-04, -1.22650999e-07, -5.56552903e-04, -1.36799082e-03,  2.92927955e-03, -2.54565511e-03, -3.73148023e-03,  5.73093042e-03,  -4.18495841e-03, -6.45794681e-03,  7.51212411e-03, -5.96545104e-03, -8.05296932e-03,  9.51649258e-03, -7.54332143e-03, -9.70574923e-03,  1.11484184e-02, -7.94080710e-03, -1.12773056e-02,  1.08945979e-02,  -8.14979250e-03, -1.19539564e-02,  1.13566513e-02, -7.92569404e-03, -1.16113034e-02,  1.04915927e-02, -7.20714216e-03, -1.04087759e-02,   9.38227121e-03, -6.25350770e-03, -8.81851285e-03,  7.29705170e-03,  -4.95217103e-03, -6.75844996e-03,  5.69282641e-03, -3.86207545e-03, -5.06005023e-03,  3.86558321e-03, -2.58060673e-03, -3.25105895e-03,  2.47706180e-03, -1.54470929e-03, -1.80749943e-03,  1.32078575e-03, -7.52231569e-04, -7.41128677e-04,  4.46050806e-04, -1.98575267e-04, -1.23744998e-04,  2.95820138e-05, -1.53553382e-11, -3.20499291e-05, 1.22714205e-04, -2.21354756e-04, -5.61928627e-04,  8.06816903e-04, -9.61104273e-04, -1.82849326e-03,  2.19825849e-03, -2.33581262e-03, -4.02347707e-03,  4.32785753e-03, -4.28839625e-03, -7.07591911e-03, 7.55806120e-03, -6.87440470e-03, -1.07833242e-02,  1.10697963e-02, -9.66848477e-03, -1.44793131e-02,  1.40425653e-02, -1.21481938e-02, -1.83709882e-02,  1.68466239e-02, -1.48092815e-02, -2.17565682e-02, 1.95467550e-02, -1.61608985e-02, -2.42266141e-02,  2.20932155e-02, -1.73742210e-02, -2.63888153e-02,  2.33321575e-02, -1.85081605e-02, -2.61563290e-02,  2.51606000e-02, -1.80674035e-02, -2.63950119e-02, 2.33579078e-02, -1.64162616e-02, -2.38865524e-02,  1.98178789e-02, -1.45084400e-02, -1.90126513e-02,  1.67420434e-02, -1.10753489e-02, -1.26501606e-02,  1.00486857e-02, -6.29095378e-03, -5.56060154e-03, 2.84130237e-03,  2.83192039e-07,  3.16043682e-03, -6.31840317e-03, 8.19260677e-03,  1.41924558e-02, -1.99088703e-02,  1.96679587e-02,  2.91596509e-02, -3.66729789e-02,  3.15651826e-02,  4.46712734e-02,  -7.27706382e-02,  4.97518993e-02,  6.67865094e-02, -1.11131008e-01,  7.75180511e-02,  1.01245362e-01, -1.56422471e-01,  1.08068706e-01,  1.67384992e-01, -2.96614103e-01,  1.81963835e-01,  3.19219686e-01, -8.99740144e-01,  7.98520746e-01};

  //Initialization of sparse vector
  for(uint8_t i=0; i<150; i++)
  	  sparse[i] = 0;
  for(uint8_t i=0; i<150; i++)
	  sparse[i] = filter_out[1490-tap_delay[i]] * coef[i];
//    for(int i=0; i<150; i++)
//    {   printf("Signal: %f\n",sparse[i]);
//        HAL_Delay(50);	}

  float h[601] = {-4.35891007e-01,  1.05475714e-01,  8.46098114e-02,  8.89438323e-02,  -7.25252958e-03, -5.87881289e-02,  1.30309077e-01, -4.11402399e-02,   7.98500458e-04, -5.78939015e-02,  5.42602731e-02,  1.08790840e-01,  -2.39948154e-01,  1.16602477e-01,  1.07630037e-01, -1.99616671e-01,  6.77914407e-02, -2.38643836e-03,  4.65776134e-02, -4.27243364e-02,  -6.29394980e-02,  1.14503410e-01, -4.19975831e-02,  7.52993192e-03,  -6.60142563e-02,  6.69044396e-02,  1.09748188e-01, -2.36051719e-01,  1.37055214e-01,  9.58112674e-02, -1.55949166e-01,  7.99207730e-02,  -1.95967456e-02,  7.58664716e-02, -1.99559550e-02, -9.25946575e-02,  1.44442521e-01, -1.56770683e-02, -3.49581773e-02, -2.51222493e-02,  9.40999043e-02,  6.61914621e-02, -1.86633894e-01,  1.60256577e-01,   4.46422128e-02, -1.13118886e-01,  1.07231095e-01, -7.78564481e-02,  1.15298655e-01,  5.97669695e-03, -1.49318774e-01,  1.83840063e-01,  5.60406344e-03, -8.42906294e-02,  3.48812425e-03,  1.00369008e-01,  1.83661372e-02, -1.76737374e-01,  1.68947161e-01,  2.92756801e-03,  -1.01324428e-01,  1.03979490e-01, -1.07188937e-01,  1.15262597e-01, -7.41169945e-03, -1.67947256e-01,  1.78707778e-01, -2.11815539e-02,  -8.97254864e-02, -4.04502347e-03,  6.81374182e-02,  2.29234423e-02, -1.80212693e-01,  1.24792254e-01,  1.72267698e-02, -1.01761908e-01,  5.26722901e-02, -9.17041109e-02,  1.28748084e-01, -6.34979695e-02,  -1.50972149e-01,  2.06840927e-01, -7.80483513e-02, -7.75208043e-02, 4.43385925e-02,  1.65677856e-02,  2.29552892e-02, -1.07750572e-01, 8.41303038e-02,  2.66532698e-03, -6.13887617e-03,  1.93340703e-02, -1.18165166e-01,  2.33429216e-01, -9.18617979e-02, -1.92175817e-01,  3.24614564e-01, -9.03486473e-02, -1.38960306e-01,  1.64074615e-01,  2.10887202e-02, -5.33850812e-02,  7.98577456e-03,  1.04547450e-01, -7.30400272e-02,  9.20937611e-02,  4.46471175e-02, -2.01193777e-01, 3.18058797e-01, -5.77500188e-02, -2.63391167e-01,  3.85265855e-01, -5.60946299e-02, -1.91865237e-01,  1.87693490e-01,  4.80687758e-02,  -9.09619565e-02, -1.03007400e-02,  1.08501518e-01, -7.79529750e-02,  4.48892203e-02,  1.54574957e-02, -1.56958920e-01,  2.35783427e-01,  -1.27678891e-01, -1.76790300e-01,  2.65566100e-01, -1.70294076e-01,  -5.80774899e-02,  4.61388362e-02, -1.18660475e-01,  1.02694245e-01, -1.72080434e-01, -1.13592996e-01,  1.56192743e-01, -1.22047552e-01, -2.57876700e-01,  1.31716371e-01,  5.96625408e-02, -4.35842055e-01, 1.31246445e-01,  1.14443963e-01, -4.98074035e-01,  2.49483912e-01, -7.18813629e-02, -4.65850621e-01,  4.25647382e-01, -2.59794076e-01,  -4.32377970e-01,  4.78854305e-01,  2.81468956e-02, -3.96021812e-01,   2.84429893e-01,  2.58561207e-02, -6.82156503e-01,  4.15988773e-01,  7.92744206e-02, -6.64621965e-01,  4.87891155e-01, -4.85163909e-02,  -4.67264435e-01,  4.86396838e-01, -1.75186890e-01, -2.73385557e-01,  4.41503821e-01, -1.12390977e-01, -2.34957391e-01,  4.08863294e-01, -1.16653148e-02, -2.84233957e-01,  4.49055314e-01, -3.59339948e-02,  -1.63210381e-01,  4.73339010e-01, -2.29169749e-01,  1.25325038e-01, 4.51122331e-01, -4.28129363e-01,  3.69805265e-01,  4.11627244e-01, -4.67287620e-01,  4.13670919e-01,  4.06974571e-01, -4.28068767e-01,  3.60854493e-01,  4.60601506e-01, -4.92939768e-01,  4.23404247e-01,  5.14435489e-01, -7.20516285e-01,  6.08213554e-01,  5.12597076e-01, -9.37511425e-01,  7.23856071e-01,  4.92284396e-01, -9.45961120e-01,  6.20240355e-01,  4.80449789e-01, -8.38632847e-01,  4.08778245e-01, 5.02381685e-01, -8.14747135e-01,  3.19462723e-01,  4.96863098e-01,  -9.19761153e-01,  3.95035615e-01,  4.17678474e-01, -9.78669996e-01,  4.28191357e-01,  2.74413710e-01, -8.33206013e-01,  2.87498784e-01, 1.26481064e-01, -5.70069584e-01,  1.14571224e-01, -9.13640297e-03, -4.04533847e-01,  1.28502877e-01, -1.76435383e-01, -3.98543901e-01, 3.67433109e-01, -4.14565460e-01, -3.84525196e-01,  6.23349163e-01,  -6.91019775e-01, -2.13411408e-01,  7.50121944e-01, -9.35601190e-01,  2.37509310e-02,  8.58656936e-01, -1.12136445e+00,  1.10438959e-01,  1.15125249e+00, -1.28356019e+00, -7.97040457e-03,  1.62981950e+00,  -1.45497244e+00, -1.51053991e-01,  2.05751647e+00, -1.60828377e+00, -1.52664229e-01,  2.27336834e+00, -1.67726249e+00, -7.53976006e-02,  2.37697900e+00, -1.64843844e+00, -1.22950182e-01,  2.52303955e+00, -1.57762756e+00, -3.10574836e-01,  2.72224113e+00, -1.52322107e+00,  -4.52321283e-01,  2.74240732e+00, -1.49178395e+00, -3.65472074e-01, 2.45154052e+00, -1.41381112e+00, -9.97033714e-02,  1.94044534e+00, -1.32548970e+00,  1.31394088e-01,  1.42779219e+00, -1.28449132e+00,  3.18685467e-01,  9.69175698e-01, -1.34787221e+00,  6.32859162e-01,  3.78026596e-01, -1.52668131e+00,  1.18967970e+00, -4.38643699e-01, -1.74379857e+00,  1.92268852e+00, -1.33238246e+00, -1.99533053e+00, 2.59620640e+00, -2.05580869e+00, -2.31294120e+00,  3.13089295e+00, -2.53075063e+00, -2.71051866e+00,  3.66158766e+00, -2.92520521e+00, -3.12589613e+00,  4.28091053e+00, -3.36092739e+00, -3.46068439e+00,  4.88577639e+00, -3.69964501e+00, -3.63910971e+00,  5.24177135e+00,  -3.78198712e+00, -3.64590446e+00,  5.27048689e+00, -3.54409716e+00,  -3.50313872e+00,  5.10577576e+00, -3.24590564e+00, -3.16381703e+00,  4.81857326e+00, -3.22827505e+00, -2.46300028e+00,  4.70505333e+00,  -2.97665733e+00, -1.47263179e+00,  4.12075784e+00, -2.76443148e+00, -1.99017312e-01,  3.32289596e+00, -2.58686594e+00,  1.30123863e+00,  2.51287776e+00, -2.62952627e+00,  2.90600555e+00,  1.85330458e+00,  -3.01729944e+00,  4.59218511e+00,  1.34881126e+00, -3.60378025e+00,  6.31454804e+00,  8.07456218e-01, -4.31183336e+00,  7.96921033e+00,  2.75109106e-01, -5.12421474e+00,  9.38500169e+00, -5.45696954e-02, -6.09796896e+00,  1.04089878e+01, -6.42684856e-02, -7.22197530e+00, 1.10093896e+01,  1.28882630e-01, -8.30455576e+00,  1.11956573e+01, 2.64805145e-01, -9.12713633e+00,  1.09577619e+01,  2.66881275e-01,  -9.57240208e+00,  1.02583173e+01,  2.33343004e-01, -9.66981703e+00,  9.09613177e+00,  1.58283286e-01, -9.42278241e+00,  7.64702833e+00,  -1.31614569e-01, -8.67805416e+00,  6.11738387e+00, -9.24375774e-01, -7.29858391e+00,  4.67401753e+00, -2.29821923e+00, -5.33067354e+00,  3.41800678e+00, -4.10650325e+00, -2.95792089e+00,  2.49523741e+00,  -6.21474851e+00, -3.59976739e-01,  2.09867195e+00, -8.66561626e+00, 2.40104592e+00,  2.39828747e+00, -1.15428616e+01,  5.29096248e+00,  3.44841275e+00, -1.47189619e+01,  8.12515619e+00,  5.15359006e+00, -1.78334815e+01,  1.06190694e+01,  7.37892807e+00, -2.05602958e+01, 1.25661128e+01,  9.98821924e+00, -2.27867949e+01,  1.39549152e+01, 1.27984888e+01, -2.45007935e+01,  1.48692592e+01,  1.54983648e+01, -2.55538781e+01,  1.53192853e+01,  1.76671453e+01, -2.56561243e+01, 1.52682758e+01,  1.89121386e+01, -2.46366448e+01,  1.47829500e+01, 1.89256326e+01, -2.26312606e+01,  1.41299481e+01,  1.74851212e+01, -1.99282654e+01,  1.36932145e+01,  1.44109462e+01, -1.67489100e+01,  1.36891854e+01,  9.54237930e+00, -1.31575189e+01,  1.42298183e+01,  2.89945961e+00, -9.32140389e+00,  1.54067980e+01, -5.31538199e+00, -5.68035272e+00,  1.74299755e+01, -1.46612696e+01, -2.69048075e+00, 2.04613062e+01, -2.46761736e+01, -6.45105877e-01,  2.43734014e+01,  -3.48701796e+01,  4.70964172e-01,  2.88486278e+01, -4.46330498e+01,  7.71139403e-01,  3.35098021e+01, -5.33057439e+01,  2.12469941e-01,  3.80214881e+01, -6.01924832e+01, -1.15278537e+00,  4.20417302e+01,  -6.47802082e+01, -2.97356830e+00,  4.50384111e+01, -6.67956368e+01,  -4.57907983e+00,  4.63945507e+01, -6.61192289e+01, -5.24792999e+00,  4.56319146e+01, -6.27694733e+01, -4.46818049e+00,  4.24992344e+01,  -5.69777981e+01, -1.84655017e+00,  3.69952926e+01, -4.92403705e+01,  3.08901306e+00,  2.91019728e+01, -4.03633030e+01,  1.09143433e+01, 1.89403266e+01, -3.12115764e+01,  2.19344286e+01,  6.97386322e+00, -2.26534178e+01,  3.56951739e+01, -6.45348698e+00, -1.56304428e+01, 5.18678303e+01, -2.01268605e+01, -1.08129513e+01,  6.95612293e+01, -3.33337801e+01, -8.86265050e+00,  8.79685139e+01, -4.54000038e+01, -1.01172854e+01,  1.06088314e+02, -5.56675175e+01, -1.45194776e+01,  1.22461535e+02, -6.35291290e+01, -2.16238994e+01,  1.35540644e+02, -6.84297815e+01, -3.06007934e+01,  1.43962879e+02, -7.03332244e+01, -4.03649939e+01,  1.46847208e+02, -6.96986986e+01, -4.95639621e+01,  1.43651768e+02, -6.72463880e+01, -5.66178035e+01,  1.33991457e+02, -6.38017330e+01, -5.98743272e+01,  1.17874763e+02, -6.03286394e+01, -5.78451274e+01,  9.59897806e+01, -5.81248879e+01, -4.93953171e+01,  6.98082987e+01, -5.86465080e+01, -3.37716428e+01,  4.12939465e+01, -6.31105250e+01, -1.07138598e+01,  1.24303888e+01, -7.22790232e+01,  1.94670922e+01, -1.47329250e+01, -8.63981028e+01,  5.57798409e+01, -3.80223678e+01, -1.05341223e+02,  9.65660322e+01, -5.52714370e+01,  -1.28550877e+02,  1.39617641e+02, -6.48170065e+01, -1.54759212e+02,  1.82431918e+02, -6.59427184e+01, -1.81905071e+02,  2.22369736e+02, -5.89293272e+01, -2.07391683e+02,  2.56784882e+02, -4.48432644e+01, -2.28469410e+02,  2.83268819e+02, -2.54725404e+01, -2.42478089e+02, 2.99929839e+02, -3.51633432e+00, -2.46852361e+02,  3.05686619e+02, 1.73448628e+01, -2.39267465e+02,  3.00381884e+02,  3.28225506e+01, -2.18046510e+02,  2.84773220e+02,  3.86822243e+01, -1.82608795e+02,  2.60504469e+02,  3.12192583e+01, -1.33639831e+02,  2.30042589e+02, 7.41136248e+00, -7.29096435e+01,  1.96576351e+02, -3.49005690e+01,  -3.10762629e+00,  1.63672838e+02, -9.65816549e+01,  7.21172588e+01,  1.34802153e+02, -1.76604086e+02,  1.48271930e+02,  1.13006603e+02, -2.71854755e+02,  2.20304979e+02,  1.00527848e+02, -3.77421306e+02, 2.83346698e+02,  9.86044840e+01, -4.86988814e+02,  3.33295723e+02, 1.07073604e+02, -5.93211134e+02,  3.67125676e+02,  1.24231634e+02, -6.87801343e+02,  3.83177336e+02,  1.46819851e+02, -7.62176764e+02,  3.81384861e+02,  1.70185012e+02, -8.08468488e+02,  3.63720138e+02, 1.88747859e+02, -8.20411390e+02,  3.34388110e+02,  1.96368930e+02, -7.94044549e+02,  2.99402184e+02,  1.86875639e+02, -7.27896663e+02, 2.65992431e+02,  1.54719545e+02, -6.23300979e+02,  2.41956911e+02, 9.56429698e+01, -4.84817468e+02,  2.35122836e+02,  7.35955707e+00, -3.20298222e+02,  2.52678761e+02, -1.09977820e+02, -1.40345389e+02,  3.00067888e+02, -2.53643206e+02,  4.27396930e+01,  3.79999086e+02, -4.18187369e+02,  2.15995979e+02,  4.91651684e+02, -5.95708044e+02, 3.66711325e+02};
  float final_out[NUM_SAMPLES];
  arm_conv_f32((float*)&sparse[0], 150, (float*)&h[0], 601, (float*)&final_out[0]);



//	/* Performance Comparison */
//  float *in = &signal_in[0], *out = &final_out[0], snr, snr_abs;
//  for(uint8_t i=0;i<15;i++)
//	snr = fabsf(arm_snr_f32(in+(i*50), out+(i*50), 50));
//  printf("SNR: %f\n",snr);

  /* Printing the values */
  //Received signal
   sample_instance=0.02/15.0; x=0.0;
    printf("RECEIVED SIGNAL\n");
    for(int i=0; i<750; i++)
    {   printf("%f, ",received_signal[i]);
  	  x = x+sample_instance;
        HAL_Delay(10);	}
    printf("\n");

  // Filter output
  //  printf("FILTER OUTPUT\n");
  //  for(int i=0; i<1499; i++)
  //  {   printf("%f\n",filter_out[i]);
  //      HAL_Delay(50);	}
  //  printf("\n");

  // Final output
    printf("FINAL OUTPUT\n");
    for(int i=0; i<150; i++)
    {   printf("%f, ",final_out[i]);
        HAL_Delay(10);	}
    printf("\n");

  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  __HAL_RCC_PWR_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);
  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI;
  RCC_OscInitStruct.HSIState = RCC_HSI_ON;
  RCC_OscInitStruct.HSICalibrationValue = RCC_HSICALIBRATION_DEFAULT;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSI;
  RCC_OscInitStruct.PLL.PLLM = 8;
  RCC_OscInitStruct.PLL.PLLN = 100;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
  RCC_OscInitStruct.PLL.PLLQ = 4;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }
  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV2;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_3) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief USART2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_USART2_UART_Init(void)
{

  /* USER CODE BEGIN USART2_Init 0 */

  /* USER CODE END USART2_Init 0 */

  /* USER CODE BEGIN USART2_Init 1 */

  /* USER CODE END USART2_Init 1 */
  huart2.Instance = USART2;
  huart2.Init.BaudRate = 9600;
  huart2.Init.WordLength = UART_WORDLENGTH_8B;
  huart2.Init.StopBits = UART_STOPBITS_1;
  huart2.Init.Parity = UART_PARITY_NONE;
  huart2.Init.Mode = UART_MODE_TX_RX;
  huart2.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  huart2.Init.OverSampling = UART_OVERSAMPLING_16;
  if (HAL_UART_Init(&huart2) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN USART2_Init 2 */

  /* USER CODE END USART2_Init 2 */

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOC_CLK_ENABLE();
  __HAL_RCC_GPIOH_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();

}

/* USER CODE BEGIN 4 */

/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */

/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/
